# Gitlab版本升级

# 一、简介

gitlab的版本规则是：`主版本(Major).次版本(Minor).补丁版本(Patch)`

- 主版本会在每年的五月22左右发布

- 次版本会在每月22号左右发布
- 补丁版本会不定时发布

版本升级说明

- 在同一个主要版本下，补丁版本和次要版本之间跳转是安全的。例如
  - `12.7.5` -> `12.10.5`
  - `11.3.4` -> `11.11.1`
  - `12.0.4` -> `12.0.12`
  - `11.11.1` -> `11.11.8`
- 而主版本更新，需要考虑版本是否可向后兼容于数据迁移
- 

说明文档：

- https://docs.gitlab.com/ee/policy/maintenance.html
- https://docs.gitlab.com/ee/update/README.html#version-specific-upgrading-instructions

# 二、升级

升级的方式步骤取决于Gitlab的部署方式，目前gitlab支持的部署方式有：`二进制包安装`、`源码编译安装`、`Docker方式安装`、`Helm方式安装`

## 1、升级前准备

- 某些主要/次要版本可能需要完成一系列的后台数据迁移

  - 对于二进制方式安装的gitlab

    - gitlab >= 12.9

    ```bash
    sudo gitlab-rails runner -e production 'puts Gitlab::BackgroundMigration.remaining'
    ```

    - gitlab <= 12.8

    ```bash
    puts Sidekiq::Queue.new("background_migration").size
    Sidekiq::ScheduledSet.new.select { |r| r.klass == 'BackgroundMigrationWorker' }.size
    ```

  - 对于源码安装的gutlab
  
    - gitlab >= 12.9
  
      ```bash
      cd /home/git/gitlab
      sudo -u git -H bundle exec rails runner -e production 'puts Gitlab::BackgroundMigration.remaining'
      ```
  
    - gitlab <= 12.8
  
      ```bash
      puts Sidekiq::Queue.new("background_migration").size
      Sidekiq::ScheduledSet.new.select { |r| r.klass == 'BackgroundMigrationWorker' }.size
      ```

## 2、主版本升级的路径

| 当前版本 | 目标版本 | 支持的版本升级路径                                           | 备注                                                         |
| :--------- | :------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| `12.9.2` | `13.4.3`   | `12.9.2` -> `12.10.14` -> `13.0.14` -> `13.4.3`              | 需要两个中间版本：最终的12.10版本以及13.0                    |
| `11.5.0` | `13.2.10`  | `11.5.0` -> `11.11.8` -> `12.0.12` -> `12.1.17` -> `12.10.14` -> `13.0.14` -> `13.2.10` | 需要五个中间版本：最终的11.11、12.0、12.1和12.10版本以及13.0 |
| `11.3.4` | `12.10.14` | `11.3.4` -> `11.11.8` -> `12.0.12` -> `12.1.17` -> `12.10.14` | 需要三个中间版本：最终的11.11和12.0版本，再加上12.1          |
| `10.4.5` | `12.9.5`   | `10.4.5` -> `10.8.7` -> `11.11.8` -> `12.0.12` -> `12.1.17` -> `12.9.5` | 需要四个中间版本：10.8、11.11、12.0和12.1，然后是12.9.5 |
| `9.2.6` | `12.2.5`   | `9.2.6` -> `9.5.10` -> `10.8.7` -> `11.11.8` -> `12.0.12` -> `12.1.17` -> `12.2.5` | 需要五个中间版本：9.5、10.8、11.11、12.0、12.1，然后是12.2。 |
| `8.13.4` | `11.3.4`   | `8.13.4` -> `8.17.7` -> `9.5.10` -> `10.8.7` -> `11.3.4`     | 8.17.7是版本8中的最新版本，9.5.10是版本9中的最新版本，10.8.7是版本10中的最新版本。 |

已实践的版本升级路线：

`11.6.1 ----> 11.11.0-ce.0(关键点) ----> 12.0.1-ce.0(关键点) ----> 12.8.0-ce.0 ----> 12.10.0(关键点) ----> 13.0.0-ce.0(关键点) ----> latest(13.8.3)`


